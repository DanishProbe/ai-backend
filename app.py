# trimmed for brevity in assistant, full code is restored above if needed